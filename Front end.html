<!DOCTYPE html>
<html>
  <head>
    <title>The Artisan Market - Handcrafted Kits & Classes</title>
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
    
    <style>
      /* --- Custom Variables for Artisan Theme --- */
      :root {
        --primary-color: #5D4037;
        --secondary-color: #FFB74D;
        --accent-color: #4CAF50;
        --background-light: #F5F5F5;
        --card-bg: #FFFFFF;
        --text-dark: #333333;
        --border-color: #E0E0E0;
      }
      body { 
        font-family: 'Arial', sans-serif; 
        background-color: var(--background-light); 
        color: var(--text-dark); 
        margin: 0; 
        line-height: 1.6;
      }
      #app { 
        max-width: 1300px; 
        margin: 40px auto; 
        padding: 30px; 
        background: var(--card-bg); 
        border-radius: 15px; 
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08); 
      }
      header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        border-bottom: 3px solid var(--secondary-color); 
        padding-bottom: 20px; 
        margin-bottom: 30px; 
      }
      h1 { 
        color: var(--primary-color); 
        font-size: 2.5em; 
        font-weight: 700;
        letter-spacing: 1px;
      }
      h2 { 
        color: var(--primary-color); 
        font-size: 1.8em;
        margin-bottom: 25px;
        font-weight: 500;
      }
      
      /* --- Buttons --- */
      .cart-button { 
        padding: 12px 25px; 
        background-color: var(--secondary-color); 
        color: var(--primary-color); 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        font-weight: 700;
        transition: background-color 0.3s, transform 0.1s; 
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .cart-button:hover:not(:disabled) { background-color: #FFCC80; transform: translateY(-1px); }
      .cart-button:disabled { background-color: #E0E0E0; color: #757575; cursor: not-allowed; box-shadow: none; }
      .checkout-btn { 
        background-color: var(--accent-color); 
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 700;
        font-size: 1.1em;
        cursor: pointer;
        margin-top: 15px;
        transition: background-color 0.3s;
      }
      .checkout-btn:hover:not(:disabled) { background-color: #388E3C; }
      .checkout-btn:disabled { background-color: #BDBDBD; cursor: not-allowed; }

      /* --- Controls (Search & Sort) --- */
      .controls { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 20px; 
        margin-bottom: 40px; 
        align-items: center; 
        padding: 20px; 
        background-color: var(--background-light); 
        border-radius: 10px;
        border: 1px solid var(--border-color);
      }
      .search-input, .sort-select { 
        padding: 10px; 
        border: 1px solid var(--border-color); 
        border-radius: 6px; 
        font-size: 1em; 
        transition: border-color 0.3s;
      }
      .search-input:focus, .sort-select:focus { 
        border-color: var(--secondary-color);
        outline: none;
      }
      .search-label { font-weight: 600; color: var(--primary-color); }
      
      /* --- Lesson Cards --- */
      .lesson-list { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
        gap: 30px; 
      }
      .lesson-card { 
        padding: 25px; 
        border-radius: 12px; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.08); 
        position: relative; 
        background: var(--card-bg);
        transition: transform 0.3s, box-shadow 0.3s;
        border: 1px solid var(--border-color);
      }
      .lesson-card:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); 
      }
      /* Removed .icon CSS here */
      .lesson-card h3 { 
        color: var(--primary-color); 
        margin-top: 0; 
        font-size: 1.5em; 
        border-bottom: 2px solid #EEE;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }
      .lesson-card p { margin: 8px 0; }
      .add-to-cart-btn { 
        width: 100%; 
        padding: 12px; 
        margin-top: 20px; 
        background-color: var(--primary-color); 
        color: white; 
        border: none; 
        border-radius: 8px; 
        cursor: pointer; 
        font-weight: 700;
        transition: background-color 0.3s;
      }
      .add-to-cart-btn:hover:not(:disabled) { background-color: #795548; }
      .add-to-cart-btn:disabled { background-color: #E74C3C; cursor: not-allowed; color: #FFFFFF; }
      .stock-low { color: #E74C3C; font-weight: 700; }

      /* --- Cart Page --- */
      .cart-page { 
        padding: 30px; 
        border-radius: 12px; 
        background: #FFF8E1;
        border: 2px solid var(--secondary-color);
      }
      .cart-list h3 { 
        font-size: 1.2em; 
        color: var(--primary-color); 
        border-bottom: 1px solid var(--border-color); 
        padding-bottom: 10px;
      }
      .cart-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 15px 0; 
        border-bottom: 1px dashed #DDD; 
      }
      .cart-item button { 
        background-color: #9E9E9E; 
        color: white; 
        border: none; 
        padding: 8px 15px; 
        border-radius: 6px; 
        cursor: pointer; 
        transition: background-color 0.3s;
      }
      .cart-item button:hover { background-color: #757575; }

      /* --- Checkout Form --- */
      .checkout-section { 
        margin-top: 40px; 
        padding: 30px; 
        background-color: var(--card-bg); 
        border-radius: 12px; 
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .form-group { margin-bottom: 20px; }
      .form-group label { display: block; margin-bottom: 8px; font-weight: 700; color: var(--primary-color); }
      .form-group input { 
        width: 100%; 
        padding: 12px; 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        box-sizing: border-box; 
        font-size: 1em;
      }
      .checkout-message { 
        padding: 15px; 
        background-color: #E8F5E9;
        color: #2E7D32;
        border: 1px solid #A5D6A7;
        border-radius: 6px; 
        font-weight: 600;
        margin-bottom: 25px;
      }
      .checkout-message.error {
        background-color: #FFEBEE;
        color: #D32F2F;
        border: 1px solid #EF9A9A;
      }
      
      .input-error {
        border: 2px solid #E74C3C !important;
        background-color: #FFF3E0;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header>
        <h1><span v-text="sitename"></span></h1>
        <button 
          v-on:click="toggleView" 
          :disabled="totalCartItems === 0 && showLessons" 
          class="cart-button"
        >
          {{ showLessons ? 'View Cart (' + totalCartItems + ')' : 'Back to Kits' }}
        </button>
      </header>

      <main>
        <div v-if="showLessons" class="lessons-view">
          <h2>Discover Handcrafted Kits & Classes</h2>
          
          <section class="controls">
            <input 
              type="text" 
              v-model="searchQuery" 
              placeholder="Search product or location..." 
              class="search-input"
              style="flex-grow: 1;"
            >
            
            <label class="search-label">Sort By:</label>
            <select v-model="sortAttribute" class="sort-select">
              <option value="subject">Product Name</option>
              <option value="location">Location</option>
              <option value="price">Price</option>
              <option value="spaces">Stock</option>
            </select>
            <select v-model="sortOrder" class="sort-select">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </section>

          <p 
            v-if="checkoutMessage" 
            class="checkout-message error" 
            :class="{ 'checkout-message error': !lessons.length || checkoutMessage.includes('Error') }"
          >
            {{ checkoutMessage }}
          </p>
          
          <section class="lesson-list">
            <div v-for="lesson in sortedAndFilteredLessons" :key="lesson._id" class="lesson-card">
              <h3>{{ lesson.subject }}</h3>
              
              <p>Location: {{ lesson.location }}</p>
              <p>Price: ${{ lesson.price.toFixed(2) }}</p>
              <p 
                :class="{ 'stock-low': lesson.spaces < 5 && lesson.spaces > 0, 'stock-out': lesson.spaces === 0 }"
              >
                Stock Left: {{ lesson.spaces }}
              </p>
              
              <button 
                @click="addToCart(lesson)" 
                :disabled="lesson.spaces === 0"
                class="add-to-cart-btn"
              >
                {{ lesson.spaces === 0 ? 'Out of Stock' : 'Add to Cart' }}
              </button>
            </div>
          </section>
        </div>
        
        <div v-else class="cart-page">
          <h2>ðŸ›’ Your Order Review</h2>
          
          <div v-if="cart.length > 0" class="cart-list">
            <h3>Total Items: {{ totalCartItems }} | Estimated Total: ${{ totalCartPrice }}</h3>
            <div v-for="item in cart" :key="item.id" class="cart-item">
              <span>{{ item.subject }} (x{{ item.quantity }})</span>
              <button @click="removeFromCart(item.id)">Remove 1</button>
            </div>
          </div>
          <div v-else>
            <p>Your shopping cart is currently empty. Add some handcrafted items!</p>
          </div>
          
          <section class="checkout-section">
            <h3>Finalize Checkout</h3>
            <p v-if="checkoutMessage" class="checkout-message" :class="{ 'error': checkoutMessage.includes('âŒ') }">{{ checkoutMessage }}</p>
            
            <form @submit.prevent="submitOrder">
              
              <div class="form-group">
                <label for="name">Full Name (Letters Only):</label>
                <input 
                    type="text" 
                    id="name" 
                    v-model="order.name" 
                    :class="{ 'input-error': order.name.length > 0 && !validateName() }"
                    required
                >
              </div>

              <div class="form-group">
                <label for="phone">Phone Number (Numbers Only):</label>
                <input 
                    type="tel" 
                    id="phone" 
                    v-model="order.phone" 
                    :class="{ 'input-error': order.phone.length > 0 && !validatePhone() }"
                    required
                >
              </div>
              
              <button type="submit" :disabled="!isFormValid" class="checkout-btn">
                Place Order Now (Total: ${{ totalCartPrice }})
              </button>
            </form>
          </section>

          <button v-on:click="toggleView" class="cart-button" style="margin-top: 30px;">
            Continue Shopping
          </button>
        </div>
      </main>
    </div>

    <script type="text/javascript">
      
      var webstore = new Vue({
        el: "#app",
        data: {
          sitename: "The Artisan Market",
          showLessons: true, 
          lessons: [],
          cart: [], 
          
          sortAttribute: 'subject', 
          sortOrder: 'asc', 
          searchQuery: '',
          
          order: {
            name: '',
            phone: ''
          },
          checkoutMessage: '',
          
          API_BASE_URL: 'https://artisan-market-api.onrender.com'
        },
        
        watch: {
          searchQuery: {
            handler: 'fetchLessons', 
            immediate: false
          }
        },

        methods: {
          toggleView: function () {
            this.showLessons = !this.showLessons;
            this.checkoutMessage = '';
          },

          async fetchLessons() {
              const url = this.searchQuery 
                  ? `${this.API_BASE_URL}/search?q=${this.searchQuery}`
                  : `${this.API_BASE_URL}/lessons`;

              try {
                  const response = await fetch(url);
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  const data = await response.json();
                  this.lessons = data; 
              } catch (error) {
                  console.error('Error fetching lessons:', error);
                  this.checkoutMessage = `âŒ Error connecting to API: ${error.message}. Please check server deployment.`;
              }
          },

          addToCart: function (lesson) {
            if (lesson.spaces > 0) {
              lesson.spaces--;
              
              const cartItem = this.cart.find(item => item.id === lesson._id); 
              
              if (cartItem) {
                cartItem.quantity++;
              } else {
                this.cart.push({
                  id: lesson._id, 
                  subject: lesson.subject,
                  price: lesson.price,
                  quantity: 1
                });
              }
            }
          },
          
          removeFromCart: function (lessonId) {
            const cartIndex = this.cart.findIndex(item => item.id === lessonId);
            
            if (cartIndex !== -1) {
              const cartItem = this.cart[cartIndex];
              cartItem.quantity--;
              
              const lesson = this.lessons.find(l => l._id === lessonId);
              if (lesson) {
                lesson.spaces++;
              }
              
              if (cartItem.quantity === 0) {
                this.cart.splice(cartIndex, 1);
              }
            }
          },
          
          validateName: function () {
              const nameRegex = /^[a-zA-Z\s]+$/;
              return nameRegex.test(this.order.name) && this.order.name.length > 0;
          },
          validatePhone: function () {
              const phoneRegex = /^[0-9]+$/;
              return phoneRegex.test(this.order.phone) && this.order.phone.length > 0;
          },

          async submitOrder() {
            if (!this.isFormValid) {
                this.checkoutMessage = 'âŒ Please complete all required fields correctly and ensure your cart is not empty.';
                return;
            }
            
            const orderData = {
                name: this.order.name,
                phone: this.order.phone,
                cart: this.cart.map(item => ({ lessonId: item.id, quantity: item.quantity })), 
                timestamp: new Date().toISOString()
            };

            let postOrderSuccess = false;

            try {
                const response = await fetch(`${this.API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    throw new Error(`Order POST failed with status: ${response.status}`);
                }
                postOrderSuccess = true;
            } catch (error) {
                this.checkoutMessage = `âŒ Error placing order: ${error.message}`;
                return;
            }

            
            if (postOrderSuccess) {
                let putUpdateSuccess = true;
                
                for (const item of this.cart) {
                    const lesson = this.lessons.find(l => l._id === item.id);
                    if (lesson) {
                        const newSpaces = lesson.spaces;
                        
                        try {
                            const putResponse = await fetch(`${this.API_BASE_URL}/lessons/${item.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ spaces: newSpaces })
                            });

                            if (!putResponse.ok) {
                                putUpdateSuccess = false;
                                console.error(`PUT Stock Update failed for ID ${item.id}`);
                            }
                        } catch (error) {
                            putUpdateSuccess = false;
                            console.error(`PUT Stock Error for ID ${item.id}:`, error);
                        }
                    }
                }

                if (putUpdateSuccess) {
                    this.checkoutMessage = 'âœ… Success! Your Artisan order has been submitted and stock updated.';
                    this.cart = [];
                    this.order = { name: '', phone: '' };
                    this.fetchLessons();
                } else {
                    this.checkoutMessage = 'âš ï¸ Order placed, but stock update failed for some items. Check API logs.';
                }
            }
          },

        },
        
        computed: {
          totalCartItems: function () {
            return this.cart.reduce((total, item) => total + item.quantity, 0);
          },
          totalCartPrice: function () {
            
            return this.cart.reduce((total, item) => total + (item.price * item.quantity), 0).toFixed(2);
          },
          
          isFormValid: function() {
            return this.cart.length > 0 && this.validateName() && this.validatePhone();
          },
          
          sortedAndFilteredLessons: function() {
            const lessons = [...this.lessons]; 
            
            lessons.sort((a, b) => {
              let valA = a[this.sortAttribute];
              let valB = b[this.sortAttribute];
              
              if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
              }
              
              if (valA < valB) {
                return this.sortOrder === 'asc' ? -1 : 1;
              }
              if (valA > valB) {
                return this.sortOrder === 'asc' ? 1 : -1;
              }
              return 0;
            });

            return lessons;
          }
        },

        mounted() {
          this.fetchLessons(); 
        }
      });
    </script>
  </body>
</html>